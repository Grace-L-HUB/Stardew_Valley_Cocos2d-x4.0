# GitHub Actions workflow for Stardew Valley Cocos2d-x 4.0 project
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # Windows build with Visual Studio 2022
  windows-2022:
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Download Cocos2d-x dependencies
        run: |
          # Temporarily modify the Python version check to allow Python 3
          (Get-Content cocos2d/download-deps.py) -replace 'if major_ver > 2:', 'if major_ver > 3:' | Set-Content cocos2d/download-deps.py
          python cocos2d/download-deps.py --r no
        shell: powershell
        
      - name: Configure CMake (Win32)
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A Win32
        shell: powershell
        
      - name: Build project
        run: |
          cd build
          cmake --build . --config Release
        shell: powershell
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-win32-build
          path: |
            build/bin/
            build/lib/
          retention-days: 7

  # Windows x64 build  
  windows-2022-x64:
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Download Cocos2d-x dependencies
        run: |
          # Temporarily modify the Python version check to allow Python 3
          (Get-Content cocos2d/download-deps.py) -replace 'if major_ver > 2:', 'if major_ver > 3:' | Set-Content cocos2d/download-deps.py
          python cocos2d/download-deps.py --r no
        shell: powershell
        
      - name: Configure CMake (x64)
        run: |
          mkdir build-x64
          cd build-x64
          cmake .. -G "Visual Studio 17 2022" -A x64
        shell: powershell
        
      - name: Build project
        run: |
          cd build-x64
          cmake --build . --config Release
        shell: powershell
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: |
            build-x64/bin/
            build-x64/lib/
          retention-days: 7

  # Linux build
  ubuntu-22_04:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libgl1-mesa-dev libglu1-mesa-dev \
                                  libasound2-dev libxrandr-dev libxi-dev libxinerama-dev \
                                  libxcursor-dev libudev-dev libgtk-3-dev
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Download Cocos2d-x dependencies
        run: |
          # Temporarily modify the Python version check to allow Python 3
          sed -i 's/if major_ver > 2:/if major_ver > 3:/' cocos2d/download-deps.py
          python cocos2d/download-deps.py --r no
        
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          
      - name: Build project
        run: |
          cd build
          make -j$(nproc)
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            build/bin/
            build/lib/
          retention-days: 7

  # macOS build
  macos-latest:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Download Cocos2d-x dependencies
        run: |
          # Temporarily modify the Python version check to allow Python 3
          sed -i 's/if major_ver > 2:/if major_ver > 3:/' cocos2d/download-deps.py
          python cocos2d/download-deps.py --r no
        
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. -GXcode -DCMAKE_BUILD_TYPE=Release
          
      - name: Build project
        run: |
          cd build
          cmake --build . --config Release
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            build/bin/
            build/lib/
          retention-days: 7

  # Android build
  android-build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Set up Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 30
          build-tools: 30.0.3
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Download Cocos2d-x dependencies
        run: |
          # Temporarily modify the Python version check to allow Python 3
          sed -i 's/if major_ver > 2:/if major_ver > 3:/' cocos2d/download-deps.py
          python cocos2d/download-deps.py --r no
        
      - name: Build Android APK
        run: |
          cd proj.android
          chmod +x gradlew
          ./gradlew assembleRelease -PPROP_BUILD_TYPE=cmake --info
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: proj.android/app/build/outputs/apk/release/*.apk
          retention-days: 7
