name: Compile Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  compile-check:
    runs-on: ubuntu-20.04
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libasound2-dev \
          libgtk-3-dev \
          libx11-dev
    
    - name: åˆ›å»ºæž„å»ºç›®å½•
      run: mkdir -p build
    
    - name: å‡†å¤‡ Cocos2d-x å¤–éƒ¨ä¾èµ–ç›®å½•
      run: |
        mkdir -p cocos2d/external
        echo '{"version": "v0"}' > cocos2d/external/version.json
        echo "ðŸ“¦ è·³è¿‡ç¬¬ä¸‰æ–¹ä¾èµ–ä¸‹è½½ï¼Œä»…è¿›è¡Œç¼–è¯‘æ£€æŸ¥"
    
    - name: é…ç½® CMake
      run: |
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DLINUX=ON \
                 -DCMAKE_CXX_FLAGS="-Wno-error=all" \
                 -DCMAKE_C_FLAGS="-Wno-error=all"
    
    - name: ç¼–è¯‘é¡¹ç›®
      run: |
        cd build
        make -j2 2>&1 | tee compile.log
        echo "ç¼–è¯‘é€€å‡ºç : $?"
      continue-on-error: true
    
    - name: åˆ†æžç¼–è¯‘ç»“æžœ
      run: |
        echo "=== ç¼–è¯‘ç»“æžœåˆ†æž ==="
        
        if [ -f "build/compile.log" ]; then
          echo "ðŸ“„ ç¼–è¯‘æ—¥å¿—æ–‡ä»¶å­˜åœ¨"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é”™è¯¯
          error_count=$(grep -c "error:" build/compile.log || echo "0")
          warning_count=$(grep -c "warning:" build/compile.log || echo "0")
          
          echo "âŒ é”™è¯¯æ•°é‡: $error_count"
          echo "âš ï¸  è­¦å‘Šæ•°é‡: $warning_count"
          
          if [ "$error_count" -eq "0" ]; then
            echo "âœ… ç¼–è¯‘æ£€æŸ¥é€šè¿‡ - æ²¡æœ‰å‘çŽ°ç¼–è¯‘é”™è¯¯"
          else
            echo "âŒ ç¼–è¯‘æ£€æŸ¥å¤±è´¥ - å‘çŽ° $error_count ä¸ªé”™è¯¯"
            echo ""
            echo "ðŸ” ä¸»è¦é”™è¯¯ä¿¡æ¯:"
            grep "error:" build/compile.log | head -10
          fi
          
          if [ "$warning_count" -gt "0" ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Šä¿¡æ¯ (å‰5ä¸ª):"
            grep "warning:" build/compile.log | head -5
          fi
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶
        obj_files=$(find build -name "*.o" 2>/dev/null | wc -l)
        echo "ðŸ”§ ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶æ•°é‡: $obj_files"
        
        if [ "$obj_files" -gt "0" ]; then
          echo "âœ… ç¼–è¯‘è¿‡ç¨‹äº§ç”Ÿäº†ç›®æ ‡æ–‡ä»¶ï¼Œè¯´æ˜Žè‡³å°‘éƒ¨åˆ†ä»£ç ç¼–è¯‘æˆåŠŸ"
        fi
    
    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: compile-logs
        path: build/compile.log
        retention-days: 7
    
    - name: ç¼–è¯‘çŠ¶æ€æ€»ç»“
      run: |
        echo "## ðŸ”¨ ç¼–è¯‘æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/compile.log" ]; then
          error_count=$(grep -c "error:" build/compile.log || echo "0")
          warning_count=$(grep -c "warning:" build/compile.log || echo "0")
          
          if [ "$error_count" -eq "0" ]; then
            echo "### âœ… ç¼–è¯‘æ£€æŸ¥ç»“æžœ: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "- æ²¡æœ‰å‘çŽ°ç¼–è¯‘é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ç¼–è¯‘æ£€æŸ¥ç»“æžœ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "- å‘çŽ° $error_count ä¸ªç¼–è¯‘é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- è­¦å‘Šæ•°é‡: $warning_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **è¯´æ˜Ž**: ç¼–è¯‘æ—¥å¿—å·²ä¸Šä¼ ä¸ºæž„å»ºäº§ç‰©ï¼Œå¯ä¸‹è½½æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ ç¼–è¯‘æ£€æŸ¥ç»“æžœ: æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- ç¼–è¯‘æ—¥å¿—æ–‡ä»¶æœªç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        fi
